---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const oeuvres = await getCollection('oeuvres');
  return oeuvres.map((oeuvre) => ({
    params: { slug: oeuvre.slug },
    props: { oeuvre },
  }));
}

const { oeuvre } = Astro.props;
const { Content } = await oeuvre.render();

// Récupérer les œuvres pour navigation prev/next
const allOeuvres = await getCollection('oeuvres');
const sortedOeuvres = allOeuvres.sort((a, b) => {
  const ordreA = a.data.ordre ?? 999;
  const ordreB = b.data.ordre ?? 999;
  if (ordreA !== ordreB) return ordreA - ordreB;
  const dateA = a.data.date ? new Date(a.data.date).getTime() : 0;
  const dateB = b.data.date ? new Date(b.data.date).getTime() : 0;
  return dateB - dateA;
});

const currentIndex = sortedOeuvres.findIndex(o => o.slug === oeuvre.slug);
const prevOeuvre = currentIndex > 0 ? sortedOeuvres[currentIndex - 1] : null;
const nextOeuvre = currentIndex < sortedOeuvres.length - 1 ? sortedOeuvres[currentIndex + 1] : null;

// Formater le prix
const formattedPrix = oeuvre.data.prix 
  ? new Intl.NumberFormat('fr-FR', { 
      style: 'currency', 
      currency: 'EUR',
      minimumFractionDigits: 0 
    }).format(oeuvre.data.prix) 
  : null;

// Formater la date
const formattedDate = oeuvre.data.date 
  ? new Intl.DateTimeFormat('fr-FR', { 
      year: 'numeric', 
      month: 'long' 
    }).format(new Date(oeuvre.data.date))
  : null;

// Images (principale + additionnelles)
const images = [oeuvre.data.image, ...(oeuvre.data.images || [])];
---

<BaseLayout 
  title={oeuvre.data.title}
  description={oeuvre.data.description || `${oeuvre.data.title} - Œuvre de Philippe Brel`}
  image={oeuvre.data.image}
>
  <article class="oeuvre-detail">
    <!-- Navigation -->
    <nav class="oeuvre-nav">
      <div class="container">
        <div class="oeuvre-nav__inner">
          <a href="/galerie" class="oeuvre-nav__back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Retour à la galerie
          </a>
          
          <div class="oeuvre-nav__arrows">
            {prevOeuvre && (
              <a href={`/oeuvres/${prevOeuvre.slug}`} class="oeuvre-nav__arrow" title={prevOeuvre.data.title}>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
                Précédent
              </a>
            )}
            {nextOeuvre && (
              <a href={`/oeuvres/${nextOeuvre.slug}`} class="oeuvre-nav__arrow" title={nextOeuvre.data.title}>
                Suivant
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </a>
            )}
          </div>
        </div>
      </div>
    </nav>

    <!-- Contenu principal -->
    <div class="oeuvre-content">
      <div class="container">
        <div class="oeuvre-layout">
          <!-- Image(s) -->
          <div class="oeuvre-images">
            <div class="oeuvre-image-main">
              <img 
                src={images[0]} 
                alt={oeuvre.data.title}
                class="oeuvre-image"
                id="mainImage"
              />
              {!oeuvre.data.disponible && (
                <span class="oeuvre-badge">Vendu</span>
              )}
            </div>
            
            {images.length > 1 && (
              <div class="oeuvre-thumbnails">
                {images.map((img, index) => (
                  <button 
                    class:list={['oeuvre-thumbnail', { 'is-active': index === 0 }]}
                    data-image={img}
                  >
                    <img src={img} alt={`${oeuvre.data.title} - vue ${index + 1}`} />
                  </button>
                ))}
              </div>
            )}
          </div>

          <!-- Informations -->
          <div class="oeuvre-info">
            <header class="oeuvre-header">
              <h1 class="oeuvre-title">{oeuvre.data.title}</h1>
              
              {formattedPrix && oeuvre.data.disponible && (
                <p class="oeuvre-prix">{formattedPrix}</p>
              )}
            </header>

            <dl class="oeuvre-meta">
              {oeuvre.data.technique && (
                <>
                  <dt>Technique</dt>
                  <dd>{oeuvre.data.technique}</dd>
                </>
              )}
              
              {oeuvre.data.dimensions && (
                <>
                  <dt>Dimensions</dt>
                  <dd>{oeuvre.data.dimensions}</dd>
                </>
              )}
              
              {formattedDate && (
                <>
                  <dt>Date</dt>
                  <dd>{formattedDate}</dd>
                </>
              )}
              
              {oeuvre.data.lieu && (
                <>
                  <dt>Lieu représenté</dt>
                  <dd>{oeuvre.data.lieu}</dd>
                </>
              )}
              
              <dt>Disponibilité</dt>
              <dd class:list={{ 'is-available': oeuvre.data.disponible, 'is-sold': !oeuvre.data.disponible }}>
                {oeuvre.data.disponible ? 'Disponible' : 'Vendu'}
              </dd>
            </dl>

            {oeuvre.data.description && (
              <div class="oeuvre-description">
                <h2>Description</h2>
                <p>{oeuvre.data.description}</p>
              </div>
            )}

            <!-- Contenu Markdown si présent -->
            <div class="oeuvre-body prose">
              <Content />
            </div>

            <!-- Actions -->
            {oeuvre.data.disponible && (
              <div class="oeuvre-actions">
                <a href={`mailto:brelphilippe@gmail.com?subject=Demande d'information : ${oeuvre.data.title}`} class="btn btn--primary">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                  </svg>
                  Demander des informations
                </a>
                <a href="tel:+33662459783" class="btn btn--outline">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                  </svg>
                  Appeler
                </a>
              </div>
            )}

            <div class="oeuvre-footer">
              <p class="oeuvre-copyright">© Philippe Brel - Tous droits réservés</p>
              <p class="oeuvre-delivery">Livraison sur demande · Worldwide delivery</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  .oeuvre-detail {
    padding-top: 80px; /* Header height */
  }
  
  /* Navigation */
  .oeuvre-nav {
    background: var(--color-bg-alt);
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--color-border);
  }
  
  .oeuvre-nav__inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .oeuvre-nav__back {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
  }
  
  .oeuvre-nav__back:hover {
    color: var(--color-accent);
  }
  
  .oeuvre-nav__arrows {
    display: flex;
    gap: var(--space-lg);
  }
  
  .oeuvre-nav__arrow {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
  }
  
  .oeuvre-nav__arrow:hover {
    color: var(--color-accent);
  }
  
  /* Content Layout */
  .oeuvre-content {
    padding: var(--space-xl) 0 var(--space-2xl);
  }
  
  .oeuvre-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-2xl);
    align-items: start;
  }
  
  /* Images */
  .oeuvre-images {
    position: sticky;
    top: calc(80px + var(--space-lg));
  }
  
  .oeuvre-image-main {
    position: relative;
    background: var(--color-bg-alt);
  }
  
  .oeuvre-image {
    width: 100%;
    height: auto;
    display: block;
    box-shadow: var(--shadow-image);
  }
  
  .oeuvre-badge {
    position: absolute;
    top: var(--space-md);
    right: var(--space-md);
    background: var(--color-accent);
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.5rem 1rem;
  }
  
  .oeuvre-thumbnails {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-md);
  }
  
  .oeuvre-thumbnail {
    width: 80px;
    height: 60px;
    padding: 0;
    border: 2px solid transparent;
    background: none;
    cursor: pointer;
    opacity: 0.6;
    transition: all var(--transition-fast);
  }
  
  .oeuvre-thumbnail.is-active,
  .oeuvre-thumbnail:hover {
    opacity: 1;
    border-color: var(--color-accent);
  }
  
  .oeuvre-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* Info */
  .oeuvre-header {
    margin-bottom: var(--space-lg);
  }
  
  .oeuvre-title {
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 400;
    margin-bottom: var(--space-md);
  }
  
  .oeuvre-prix {
    font-family: var(--font-display);
    font-size: 1.5rem;
    color: var(--color-accent);
    margin: 0;
  }
  
  /* Meta */
  .oeuvre-meta {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: var(--space-sm) var(--space-md);
    padding: var(--space-lg) 0;
    border-top: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
    margin-bottom: var(--space-lg);
  }
  
  .oeuvre-meta dt {
    font-size: 0.8125rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
  }
  
  .oeuvre-meta dd {
    font-size: 1rem;
    color: var(--color-text);
    margin: 0;
  }
  
  .oeuvre-meta dd.is-available {
    color: #2e7d32;
    font-weight: 500;
  }
  
  .oeuvre-meta dd.is-sold {
    color: var(--color-accent);
    font-weight: 500;
  }
  
  /* Description */
  .oeuvre-description h2 {
    font-size: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-sm);
  }
  
  .oeuvre-description p {
    color: var(--color-text-muted);
    line-height: 1.8;
  }
  
  .oeuvre-body {
    margin-top: var(--space-lg);
  }
  
  .oeuvre-body:empty {
    display: none;
  }
  
  /* Actions */
  .oeuvre-actions {
    display: flex;
    gap: var(--space-md);
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
  }
  
  /* Footer */
  .oeuvre-footer {
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
  }
  
  .oeuvre-copyright,
  .oeuvre-delivery {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin: 0;
  }
  
  .oeuvre-delivery {
    margin-top: var(--space-xs);
  }
  
  /* Responsive */
  @media (max-width: 1000px) {
    .oeuvre-layout {
      grid-template-columns: 1fr;
      gap: var(--space-xl);
    }
    
    .oeuvre-images {
      position: static;
    }
  }
  
  @media (max-width: 600px) {
    .oeuvre-nav__arrows {
      display: none;
    }
    
    .oeuvre-actions {
      flex-direction: column;
    }
    
    .oeuvre-meta {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Thumbnail switcher
  const thumbnails = document.querySelectorAll('.oeuvre-thumbnail');
  const mainImage = document.getElementById('mainImage') as HTMLImageElement;
  
  thumbnails.forEach(thumb => {
    thumb.addEventListener('click', () => {
      const newSrc = thumb.getAttribute('data-image');
      if (newSrc && mainImage) {
        mainImage.src = newSrc;
        thumbnails.forEach(t => t.classList.remove('is-active'));
        thumb.classList.add('is-active');
      }
    });
  });
</script>

